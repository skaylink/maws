#!/usr/bin/env bash
#MISE description="Build the binary"
#MISE depends=["build:wheel"]
set -e
tmpdir="$(mktemp -d)"
deps=()
if ! patchelf --help >/dev/null 2>&1; then
    deps+=("patchelf")
fi
if ! gcc --help >/dev/null 2>&1; then
    deps+=("gcc")
fi
if ! ccache --help >/dev/null 2>&1; then
    deps+=("ccache")
fi
if [[ -n "${deps[*]}" ]]; then
    echo "Installing dependencies (${deps[*]})"
    if [ "${EUID}" -ne 0 ]; then
      echo "Please provide sudo password"
      aptget=("sudo" "apt-get" "-qqy")
    else
      aptget=("apt-get" "-qqy")
    fi
    "${aptget[@]}" update
    # shellcheck disable=SC2068
    "${aptget[@]}" install ${deps[@]}
fi
echo -e "from maws.main import app\n\napp()" >"${tmpdir}"/cli.py
uv run nuitka --onefile --remove-output -o dist/maws "${tmpdir}"/cli.py
rm -rf "${tmpdir}"
