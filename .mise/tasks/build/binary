#!/usr/bin/env bash
#MISE description="Build the binary"
#MISE depends=["build:wheel"]
set -e
tmpdir="$(mktemp -d)"
uv sync --group build
deps=()
if ! patchelf --help >/dev/null 2>&1; then
    deps+=("patchelf")
fi
if ! gcc --help >/dev/null 2>&1; then
    deps+=("gcc")
fi
if [[ -n "${deps[*]}" ]]; then
    echo "Installing dependencies (${deps[*]}), please give sudo password if prompted"
    sudo apt-get -qq update
    # shellcheck disable=SC2068
    sudo apt-get -qqy install ${deps[@]}
fi
echo -e "from maws.main import app\n\napp()" >"${tmpdir}"/cli.py
uv run nuitka --onefile --remove-output -o dist/maws "${tmpdir}"/cli.py
rm -rf "${tmpdir}"
