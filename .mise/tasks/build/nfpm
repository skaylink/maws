#!/usr/bin/env bash
#MISE description="Create nfpm config"
#MISE depends=["build:binary"]
set -e
deps=()
if ! file --help >/dev/null 2>&1; then
    deps+=("file")
fi
if [[ -n "${deps[*]}" ]]; then
    echo "Installing dependencies (${deps[*]})"
    if [ "${EUID}" -ne 0 ]; then
      echo "Please provide sudo password"
      aptget=("sudo" "apt-get" "-qqy")
    else
      aptget=("apt-get" "-qqy")
    fi
    "${aptget[@]}" update
    # shellcheck disable=SC2068
    "${aptget[@]}" install ${deps[@]}
fi
IFS=, read -r -a _file < <(file -b dist/maws)
case "${_file[1]// /}" in
    "x86-64")
        architecture="amd64"
	;;
    "ARMaarch64")
        architecture="arm64"
	;;
esac
version="$(uv run python -c 'import maws; print(maws.__version__)')"
cat >"/tmp/nfpm.yaml" <<EOF
name: maws
arch: ${architecture}
version: ${version}
version_schema: none
maintainer: "Skaylink GmbH Managed AWS <managed-aws@support.skaylink.com>"
description: Skaylink Managed AWS command line client.
homepage: https://github.com/skaylink/maws
contents:
  - src: dist/maws
    dst: /usr/bin/maws
    file_info:
      mode: 0755
EOF
